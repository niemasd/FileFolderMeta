<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON File Tree Viewer</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121826;
      --panel2: #0f1520;
      --text: #e6edf3;
      --muted: #9aa4b2;
      --line: #243041;
      --accent: #6ea8fe;
      --good: #48d597;
      --warn: #ffcc66;
      --bad: #ff6b6b;
      --chip: #1b2636;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0));
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    header h1 {
      font-size: 16px;
      margin: 0;
      letter-spacing: 0.2px;
      color: var(--text);
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-left: auto;
    }
    .btn {
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn:hover { border-color: rgba(110,168,254,0.6); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .file {
      border: 1px dashed var(--line);
      padding: 8px 10px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    input[type="file"] { display: none; }
    .layout {
      display: grid;
      grid-template-columns: 1.25fr 0.9fr;
      gap: 12px;
      padding: 12px;
      height: calc(100vh - 66px);
    }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; height: auto; }
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 320px;
    }
    .panelHeader {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,0.02);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .crumbs {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 13px;
      color: var(--muted);
      user-select: none;
    }
    .crumb {
      padding: 4px 8px;
      border: 1px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      color: var(--text);
      background: rgba(255,255,255,0.02);
    }
    .crumb:hover { border-color: rgba(110,168,254,0.4); }
    .sep { color: var(--muted); opacity: 0.7; }
    .search {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1 1 260px;
      justify-content: flex-end;
    }
    .search input {
      width: min(420px, 100%);
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
      font-size: 13px;
    }
    .search input:focus { border-color: rgba(110,168,254,0.7); }
    .list {
      overflow: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .row {
      display: grid;
      grid-template-columns: 28px 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      cursor: pointer;
      background: rgba(255,255,255,0.02);
    }
    .row:hover { border-color: rgba(110,168,254,0.35); background: rgba(110,168,254,0.06); }
    .row.active { border-color: rgba(110,168,254,0.8); background: rgba(110,168,254,0.10); }
    .icon {
      width: 28px; height: 28px;
      display: grid; place-items: center;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      font-size: 14px;
    }
    .name {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .title {
      font-weight: 600;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .chip {
      font-size: 11px;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,0.08);
      background: var(--chip);
      padding: 3px 7px;
      border-radius: 999px;
    }
    .chip.good { color: var(--good); border-color: rgba(72,213,151,0.3); }
    .chip.warn { color: var(--warn); border-color: rgba(255,204,102,0.3); }
    .chip.bad { color: var(--bad); border-color: rgba(255,107,107,0.3); }

    .details {
      padding: 12px 14px;
      overflow: auto;
      line-height: 1.35;
    }
    .details h2 {
      margin: 0 0 6px 0;
      font-size: 15px;
    }
    .details p {
      margin: 6px 0 10px 0;
      color: var(--muted);
      font-size: 13px;
    }
    .kv {
      border-top: 1px solid var(--line);
      margin-top: 10px;
      padding-top: 10px;
      display: grid;
      grid-template-columns: 170px 1fr;
      gap: 8px 12px;
      font-size: 13px;
    }
    .k { color: var(--muted); }
    .v {
      color: var(--text);
      overflow-wrap: anywhere;
      white-space: pre-wrap;
    }
    .emptyState {
      padding: 14px;
      color: var(--muted);
      font-size: 13px;
    }
    .footerHint {
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      background: rgba(255,255,255,0.02);
    }
    code.inline {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 1px 6px;
    }
  </style>
</head>
<body>
  <header>
    <h1>JSON File Tree Viewer</h1>

    <label class="file btn" for="fileInput" title="Choose a JSON file">
      üìÑ Load JSON‚Ä¶
    </label>
    <input id="fileInput" type="file" accept=".json,application/json" />

    <div class="controls">
      <button id="backBtn" class="btn" disabled>‚Üê Back</button>
      <button id="rootBtn" class="btn" disabled>‚ü≤ Root</button>
      <button id="exportBtn" class="btn" disabled title="Download current selection as JSON">Export selection</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel" aria-label="Browser">
      <div class="panelHeader">
        <div class="crumbs" id="crumbs"></div>
        <div class="search">
          <input id="searchBox" type="search" placeholder="Search in this folder‚Ä¶" disabled />
        </div>
      </div>
      <div class="list" id="list"></div>
      <div class="footerHint" id="hint">
        Load a JSON file to begin. Folders are any object with a <code class="inline">children</code> key (even empty).
      </div>
    </section>

    <aside class="panel" aria-label="Details">
      <div class="panelHeader">
        <div style="font-size:13px;color:var(--muted);">Selection details</div>
      </div>
      <div class="details" id="details">
        <div class="emptyState">
          No file loaded yet. Click <span class="btn" style="cursor:default;">üìÑ Load JSON‚Ä¶</span>
        </div>
      </div>
    </aside>
  </main>

  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    const isObject = (x) => x !== null && typeof x === "object" && !Array.isArray(x);
    const hasChildrenKey = (node) => isObject(node) && Object.prototype.hasOwnProperty.call(node, "children");
    const isFolderLike = (node) => hasChildrenKey(node) && Array.isArray(node.children);

    const getName = (node) => (isObject(node) && typeof node.name === "string" && node.name.trim()) ? node.name.trim() : "Root";
    const getFormat = (node) => (isObject(node) && typeof node.format === "string" && node.format.trim()) ? node.format.trim() : "";

    function safeStringify(value) {
      try {
        if (typeof value === "string") return value;
        if (typeof value === "number" || typeof value === "boolean") return String(value);
        if (value === null) return "null";
        if (value === undefined) return "undefined";
        return JSON.stringify(value, null, 2);
      } catch {
        return String(value);
      }
    }

    function nodeBadge(node) {
      if (isFolderLike(node)) {
        const n = Array.isArray(node.children) ? node.children.length : 0;
        return { label: `children: ${n}`, cls: n === 0 ? "warn" : "good" };
      }
      const fmt = getFormat(node);
      return { label: fmt ? fmt : "file", cls: fmt ? "" : "warn" };
    }

    // -----------------------------
    // App state
    // -----------------------------
    let root = null;
    // pathStack holds nodes representing the "current folder" path.
    // root itself can be a folder-like node OR a wrapper object with children.
    let pathStack = [];
    let selectedNode = null;
    let selectedRowEl = null;

    // -----------------------------
    // DOM refs
    // -----------------------------
    const fileInput = document.getElementById("fileInput");
    const listEl = document.getElementById("list");
    const detailsEl = document.getElementById("details");
    const crumbsEl = document.getElementById("crumbs");
    const searchBox = document.getElementById("searchBox");
    const backBtn = document.getElementById("backBtn");
    const rootBtn = document.getElementById("rootBtn");
    const exportBtn = document.getElementById("exportBtn");
    const hintEl = document.getElementById("hint");

    // -----------------------------
    // Rendering
    // -----------------------------
    function renderCrumbs() {
      // If we're at the virtual root, keep the breadcrumb bar empty
      crumbsEl.innerHTML = "";

      const fullPath = pathStack.length ? pathStack : [root];

      // Always start with root
      const rootCrumb = document.createElement("span");
      rootCrumb.className = "crumb";
      rootCrumb.textContent = getName(root);
      rootCrumb.title = "Go to root";
      rootCrumb.onclick = () => goRoot();
      crumbsEl.appendChild(rootCrumb);

      // If root itself is named and folder-like, include it as first element.
      // But keep UI simple: show stack nodes beyond root when navigating.
      for (let i = 0; i < fullPath.length; i++) {
        const node = fullPath[i];
        if (node === root) continue;

        const sep = document.createElement("span");
        sep.className = "sep";
        sep.textContent = "‚Ä∫";
        crumbsEl.appendChild(sep);

        const c = document.createElement("span");
        c.className = "crumb";
        c.textContent = getName(node);
        c.title = "Go to this folder";
        c.onclick = () => {
          // Jump to that index in the stack
          const idx = pathStack.indexOf(node);
          if (idx >= 0) {
            pathStack = pathStack.slice(0, idx + 1);
            clearSelection();
            render();
          }
        };
        crumbsEl.appendChild(c);
      }
    }

    function currentFolder() {
      if (!root) return null;
      if (pathStack.length) return pathStack[pathStack.length - 1];
      return root;
    }

    function getChildren(node) {
      if (!node) return [];
      if (isFolderLike(node)) return node.children;
      // If root isn't folder-like but is an object/array, attempt to treat it as a container.
      if (Array.isArray(node)) return node;
      return [];
    }

    function renderList() {
      listEl.innerHTML = "";
      if (!root) return;

      const folder = currentFolder();
      let children = getChildren(folder);

      // If the loaded JSON root is an array, treat that as root children
      if (Array.isArray(root) && pathStack.length === 0) children = root;

      // Search filter
      const q = (searchBox.value || "").trim().toLowerCase();
      if (q) {
        children = children.filter(ch => {
          const n = getName(ch).toLowerCase();
          const f = getFormat(ch).toLowerCase();
          return n.includes(q) || f.includes(q);
        });
      }

      if (!Array.isArray(children) || children.length === 0) {
        const empty = document.createElement("div");
        empty.className = "emptyState";
        empty.textContent = q ? "No matches in this folder." : "This folder is empty.";
        listEl.appendChild(empty);
        return;
      }

      // Sort: folders first, then files, alpha by name
      const sorted = [...children].sort((a, b) => {
        const af = isFolderLike(a) ? 0 : 1;
        const bf = isFolderLike(b) ? 0 : 1;
        if (af !== bf) return af - bf;
        return getName(a).localeCompare(getName(b));
      });

      for (const node of sorted) {
        const row = document.createElement("div");
        row.className = "row";
        row.tabIndex = 0;

        const icon = document.createElement("div");
        icon.className = "icon";
        icon.textContent = isFolderLike(node) ? "üìÅ" : "üìÑ";

        const nameWrap = document.createElement("div");
        nameWrap.className = "name";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = getName(node);

        const subtitle = document.createElement("div");
        subtitle.className = "subtitle";
        subtitle.textContent = (getFormat(node) ? `Format: ${getFormat(node)}` : "File");

        nameWrap.appendChild(title);
        nameWrap.appendChild(subtitle);

        const meta = document.createElement("div");
        meta.className = "meta";

        const b = nodeBadge(node);
        const chip = document.createElement("span");
        chip.className = `chip ${b.cls || ""}`.trim();
        chip.textContent = b.label;
        meta.appendChild(chip);

        // Count extra attributes
        if (isObject(node)) {
          const extra = Object.keys(node).filter(k => !["name", "format", "children"].includes(k));
          if (extra.length) {
            const chip2 = document.createElement("span");
            chip2.className = "chip";
            chip2.textContent = `attrs: ${extra.length}`;
            meta.appendChild(chip2);
          }
        }

        row.appendChild(icon);
        row.appendChild(nameWrap);
        row.appendChild(meta);

        const activate = () => {
          setSelection(node, row);
          if (isFolderLike(node)) {
            // Enter folder on click (as requested)
            enterFolder(node);
          } else {
            // Summarize file on click
            renderDetails(node, { mode: "file" });
          }
        };

        // Click enters folder (if folder) OR shows file summary (if file)
        row.addEventListener("click", activate);
        row.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            activate();
          }
        });

        listEl.appendChild(row);
      }
    }

    function renderDetails(node, opts = {}) {
      if (!node || node.__virtualRoot) {
        detailsEl.innerHTML = `<div class="emptyState">Select a folder or file</div>`;
        exportBtn.disabled = true;
        return;
      }

      exportBtn.disabled = false;

      const isFolder = isFolderLike(node);
      const name = getName(node);
      const format = getFormat(node);

      const header = document.createElement("div");

      const h2 = document.createElement("h2");
      h2.textContent = name;
      header.appendChild(h2);

      const p = document.createElement("p");
      p.textContent = `${format} object`
      if (isFolder) {
        const n = Array.isArray(node.children) ? node.children.length : 0;
        p.textContent += ` containing ${n} item(s)`;
      }
      header.appendChild(p);

      // Key/value grid of extra attributes (and core fields)
      const kv = document.createElement("div");
      kv.className = "kv";

      const rows = [];

      // Core fields
      rows.push(["name", name]);
      if (format) rows.push(["format", format]);

      // Extra attributes
      if (isObject(node)) {
        const keys = Object.keys(node)
          .filter(k => !["name", "format", "children"].includes(k))
          .sort((a, b) => a.localeCompare(b));
        for (const k of keys) rows.push([k, node[k]]);
      }

      for (const [k, v] of rows) {
        const kk = document.createElement("div");
        kk.className = "k";
        kk.textContent = k;

        const vv = document.createElement("div");
        vv.className = "v";
        vv.textContent = typeof v === "string" ? v : safeStringify(v);

        kv.appendChild(kk);
        kv.appendChild(vv);
      }

      detailsEl.innerHTML = "";
      detailsEl.appendChild(header);
      detailsEl.appendChild(kv);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function render() {
      backBtn.disabled = !(pathStack.length > 0);
      rootBtn.disabled = !root;

      searchBox.disabled = !root;
      hintEl.textContent = root
        ? `Click a folder-like item to enter it. Click a file to view its summary.`
        : `Load a JSON file to begin. Folders are any object with a "children" key (even empty).`;

      renderCrumbs();
      renderList();

      // If no selection, show current folder details by default
      if (!selectedNode) {
        const folder = currentFolder();
        if (folder) renderDetails(folder, { mode: "folder" });
      }
    }

    // -----------------------------
    // Navigation / selection
    // -----------------------------
    function clearSelection() {
      selectedNode = null;
      if (selectedRowEl) selectedRowEl.classList.remove("active");
      selectedRowEl = null;
    }

    function setSelection(node, rowEl) {
      selectedNode = node;
      if (selectedRowEl && selectedRowEl !== rowEl) selectedRowEl.classList.remove("active");
      selectedRowEl = rowEl;
      if (selectedRowEl) selectedRowEl.classList.add("active");
    }

    function enterFolder(node) {
      if (!isFolderLike(node)) return;
      // push into stack
      pathStack.push(node);
      // entering a folder should show its attributes too (as requested)
      clearSelection();
      searchBox.value = "";
      render();
      renderDetails(node, { mode: "folder" });
    }

    function goBack() {
      if (pathStack.length === 0) return;
      pathStack.pop();
      clearSelection();
      searchBox.value = "";
      render();
    }

    function goRoot() {
      if (!root) return;
      pathStack = [];
      clearSelection();
      searchBox.value = "";
      render();
    }

    // -----------------------------
    // Loading JSON
    // -----------------------------
    async function loadFromFile(file) {
      const text = await file.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        detailsEl.innerHTML = `<div class="emptyState"><b style="color:var(--bad)">Invalid JSON.</b><br/>${escapeHtml(e.message || String(e))}</div>`;
        return;
      }

      // Root can be an object or array.
      // If object and lacks children, we still show its attributes, but the "list" will be empty unless it's folder-like.
      root = {
        name: file.name,
        format: "virtual-root",
        children: [data],
        __virtualRoot: true
      };
      pathStack = [];

      clearSelection();
      searchBox.value = "";

      render();

      // Show root attributes immediately
      renderDetails(root, { mode: isFolderLike(root) ? "folder" : "file" });
    }

    // -----------------------------
    // Export selection as JSON
    // -----------------------------
    function exportSelection() {
      const node = selectedNode || currentFolder() || root;
      if (!node) return;

      const blob = new Blob([JSON.stringify(node, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${(getName(node) || "selection").replace(/[^\w.-]+/g, "_")}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // -----------------------------
    // Events
    // -----------------------------
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (file) loadFromFile(file);
      // Reset input so re-selecting the same file triggers change
      fileInput.value = "";
    });

    backBtn.addEventListener("click", goBack);
    rootBtn.addEventListener("click", goRoot);
    exportBtn.addEventListener("click", exportSelection);

    searchBox.addEventListener("input", () => {
      // Keep selection but re-render list
      renderList();
    });

    // Simple global keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
        e.preventDefault();
        if (!searchBox.disabled) searchBox.focus();
      }
      if (e.key === "Backspace" && document.activeElement !== searchBox) {
        // Navigate back unless typing in an input
        const tag = (document.activeElement?.tagName || "").toLowerCase();
        if (tag !== "input" && tag !== "textarea") {
          goBack();
        }
      }
    });

    // Initial render
    render();
  </script>
</body>
</html>